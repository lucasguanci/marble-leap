var particle = new Particle();
// var webStatus;

// devices' globals
var token = "e01ac33b287dafe5f610a76532a0f1875d7a7fb2";
var tavolo = "38002d000a47343432313031";
var devices = {
  "oro": "260030000d47343432313031",
  "board": "1e001f000747343337373738",
  "lamp": "22002e000947343432313031",
  "led": "360041000547343138333038"
}

/**
 * Main
 */
$(document).ready(function(){
  // init objects' buttons
  var options = {
    onSwitchChange: function(event, state) {
      // Return false to prevent the toggle from switching.
      return false;
    }
  };
  $("input[name='oroSwitch']").bootstrapSwitch();
  $("input[name='lampSwitch']").bootstrapSwitch();
  $("input[name='boardSwitch']").bootstrapSwitch();
  // connect to Particle's cloud and init the script
  connectParticle();
  // setup objects
  // orologio
  P.listen.statusChanged("oro");
  $('input[name="oroSwitch"]').on('switchChange.bootstrapSwitch', function(event,state){
    P.speak.switching("oro");
  });
  // lamp
  P.listen.statusChanged("lamp");
  $('input[name="lampSwitch"]').on('switchChange.bootstrapSwitch', function(event, state) {
      P.speak.switching("lamp");
  });
  // board
  P.listen.statusChanged("board");
  $('input[name="boardSwitch"]').on('switchChange.bootstrapSwitch', function(event, state) {
      P.speak.switching("board");
  });
  // led
  $('button[name="ledSwitch"]').on('click', function(event, state) {
      P.speak.switching("led");
  });
  P.check.connected("lamp");
  P.check.connected("board");
  P.check.connected("oro");
  P.check.connected("led");
  // check for devices' status every n milliseconds
  var lampCheck = window.setInterval(P.check.connected, 10000, "lamp");
  var boardCheck = window.setInterval(P.check.connected, 10000, "board");
  var oroCheck = window.setInterval(P.check.connected, 10000, "oro");
  var ledCheck = window.setInterval(P.check.connected, 10000, "led");
})

/**
 * Functions
 */
function connectParticle() {
  particle.login({username: 'valentina.lapolla@gmail.com', password: 'mocamboiot30'})
    .then(function(data){
      console.log('API call completed on promise resolve: ', data.body.access_token);
      // get and display devices' status
      window.setTimeout(function(){Utils.setDisplayWebStatus("lamp")},0);
      window.setTimeout(function(){Utils.setDisplayWebStatus("board")},200);
      window.setTimeout(function(){Utils.setDisplayWebStatus("oro")},400);
    },
    function(err) {
      console.log('API call completed on promise fail: ', err);
    })
}
function checkDevicesRunning() {
  // check if devices are currently running
  console.log("Devices' status has been updated.");
}

/**
 * IIFE
 */
var Utils = (function(){
  return {
    variable: "on",
    webStatus: {
      "oro": "null",
      "lamp": "null",
      "board": "null",
      "led": "null"
    },
    connected: {
      "oro": false,
      "lamp": false,
      "board": false,
      "led": false
    },
    error: 0,
    setDisplayWebStatus: function(device) {
      var variableName = device+"Status";
      var inputName = device+"Switch";
      var device_id = devices[device];
      particle.getVariable(
        { deviceId: device_id, name: variableName, auth: token }
      ).then(
        function(data){
          console.log('[WEB] '+device+' variable retrieved successfully:', data.body.result);
          Utils.webStatus[device] = data.body.result;
          if ( Utils.webStatus[device] == "on" ) {
            $('input[name="'+inputName+'"]').bootstrapSwitch('state', true, true);
          } else {
            $('input[name="'+inputName+'"]').bootstrapSwitch('state', false, true);
          }
        },
        function(err){
          console.log('[WEB] '+device+'An error occurred while getting attrs:', err);
          Utils.error = 1;
        }
      );
    }
  }
})();

var P = (function(){
  return {
    listen: {
      statusChanged: function(device) {
        var eventName = device+"StatusChanged";
        var device_id = devices[device];
        particle.getEventStream({ deviceId: device_id, name: eventName, auth: token })
          .then(function(stream){
            stream.on('event', function(data) {
              console.log('[WEB] '+device+" has been switched!");
              Utils.setDisplayWebStatus(device);
            })
          })
      },
      upAndRunning: function(device) {
        var eventName = device+"UpAndRunning";
        particle.getEventStream(
          { deviceId: device, name: eventName, auth: token }
        )
          .then(function(stream){
            stream.on('event',function(data){
              console.log('[WEB] '+device+"is now up and running");
              Utils.setDisplayWebStatus(device);
            })
          })
      }
    },
    speak: {
      switching: function(device) {
        var eventName = device+"Switching";
        console.log('[WEB] '+"request for switching "+device);
        particle.publishEvent(
          {name: eventName, data: {}, auth: token }
        ).then(
          function(){
            console.log('[P-cloud] '+device+" is switching");
          },
          function(err) {
            console.log("[P-cloud] can't switch device, "+err);
          }
        );
      }
      // notifyStatus: function() {},
    },
    check: {
      connected: function(device) {
        var url = "https://api.particle.io/v1/devices/"+devices[device]+"\?access_token\="+token;
        $.get(url, function(data){
          if ( data.connected ) {
            Utils.connected[device] = true;
            $("div.device-"+device).css("opacity",1);
          } else {
            Utils.connected[device] = false;
            $("div.device-"+device).css("opacity",0.3);
          }
          console.log(device+"'s connection checked.");
        });
      }
    }
  }
})();
